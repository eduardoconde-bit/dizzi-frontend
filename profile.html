<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Perfil - Dizzi</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 font-sans">

  <!-- Header unificado -->
  <header class="bg-gray-900 text-white sticky top-0 z-50 shadow-md">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <!-- Logo -->
        <div class="text-2xl font-bold text-cyan-400">
          Dizzi
        </div>

        <!-- Menu Desktop -->
        <nav class="hidden md:flex space-x-8">
          <a href="create.html" class="hover:text-cyan-400 transition">Criar Votação</a>
          <a href="vote.html" class="hover:text-cyan-400 transition">Votar</a>
          <a href="#" id="logoutLink" class="hover:text-red-400 transition">Sair</a>
        </nav>

        <!-- Botão Menu Mobile -->
        <div class="md:hidden">
          <button id="menu-toggle" class="text-2xl focus:outline-none">
            ☰
          </button>
        </div>
      </div>
    </div>

    <!-- Menu Mobile -->
    <div id="mobile-menu" class="md:hidden hidden px-4 pb-4 bg-gray-900">
      <a href="create.html" class="block py-2 text-white hover:text-cyan-400">Criar Votação</a>
      <a href="vote.html" class="block py-2 text-white hover:text-cyan-400">Votar</a>
      <a href="#" id="logoutLinkMobile" class="block py-2 text-red-400 hover:text-red-300">Sair</a>
    </div>
  </header>

  <!-- Conteúdo -->
  <main class="max-w-3xl mx-auto mt-10 p-6 bg-white rounded-xl shadow-md">
    <h2 class="text-3xl font-bold mb-4 text-gray-800">Perfil do Usuário</h2>

    <!-- Dados do usuário -->
    <div class="mb-6">
      <!-- Avatar simples -->
      <div class="relative">
        <!-- Avatar -->
        <div id="avatarWrapper"
          class="w-24 h-24 rounded-full border-4 border-pink-500 p-1 cursor-pointer hover:scale-105 transition-transform">
          <img id="avatar" src="" class="w-full h-full rounded-full object-cover">
        </div>

        <!-- Modal overlay estilo Instagram -->
        <div id="avatarModal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 flex items-center justify-center">
          <div class="bg-white rounded-xl w-80 overflow-hidden shadow-lg">
            <button id="addPhoto" class="w-full py-4 border-b text-blue-600 font-semibold hover:bg-gray-100">
              Adicionar Foto
            </button>
            <button id="removePhoto" class="w-full py-4 border-b text-red-600 font-semibold hover:bg-gray-100">
              Remover Foto
            </button>
            <button id="cancel" class="w-full py-4 font-semibold hover:bg-gray-100">
              Cancelar
            </button>
          </div>
        </div>

        <!-- Input de arquivo oculto -->
        <input id="fileInput" type="file" accept="image/*" class="hidden">
        <input type="hidden" id="actionPerformed" name="action" value="add_avatar">
      </div>


      <p class="text-lg"><strong>usuário:</strong>
        <span id="userName" class="text-blue-600 font-semibold"></span>
      </p>
    </div>

    <!-- Lista de votações -->
    <div class="mt-10 mb-4 flex justify-between items-stretch gap-4">
      <div onclick="loadPollsUI()"
        class="flex-1 bg-cyan-100 rounded-lg py-4 text-center transition-transform duration-200 hover:scale-105 hover:bg-cyan-200 cursor-pointer flex items-center justify-center">
        <h3 class="text-2xl font-semibold text-cyan-700 break-words">Minhas Votações</h3>
      </div>
      <div onclick="loadMyVotesUI()"
        class="flex-1 bg-pink-100 rounded-lg py-4 text-center transition-transform duration-200 hover:scale-105 hover:bg-pink-200 cursor-pointer flex items-center justify-center">
        <h3 class="text-2xl font-semibold text-pink-700 break-words">Meus Votos</h3>
      </div>
    </div>

    <ul id="pollsList" class="space-y-4">
      <!-- Itens serão inseridos aqui -->
    </ul>
  </main>

  <script>
    // Menu mobile toggle
    const toggleBtn = document.getElementById('menu-toggle');
    const mobileMenu = document.getElementById('mobile-menu');
    const userAvatar = document.getElementById('userAvatar');
    toggleBtn.addEventListener('click', () => {
      mobileMenu.classList.toggle('hidden');
    });

    const avatarWrapper = document.getElementById('avatarWrapper');
    const avatarModal = document.getElementById('avatarModal');
    const fileInput = document.getElementById('fileInput');
    const actionInput = document.getElementById('actionPerformed');
    const avatar = document.getElementById('avatar');
    const defaultAvatar = "https://img.freepik.com/premium-vector/character-avatar-isolated_729149-194801.jpg?semt=ais_incoming&w=740&q=80";

    // Abrir modal ao clicar no avatar
    avatarWrapper.addEventListener('click', () => {
      avatarModal.classList.remove('hidden');
    });

    // Fechar modal ao clicar em Cancelar
    document.getElementById('cancel').addEventListener('click', () => {
      avatarModal.classList.add('hidden');
    });

    // Adicionar Foto
    document.getElementById('addPhoto').addEventListener('click', () => {
      console.log('Ação: Adicionar Foto');
      fileInput.click();
      avatarModal.classList.add('hidden');
    });

    /**
    * Converte uma string UTC (ISO ou "YYYY-MM-DD HH:MM:SS") para hora local
    * @param {string} utcDateTime - Data/hora em UTC
    * @param {string} [options] - opções de formatação (opcional)
    * @returns {string} - data/hora formatada em fuso local
    */
    function utcToLocal(utcDateTime, options = {}) {
      // Se receber formato 'YYYY-MM-DD HH:MM:SS', substitui espaço por T
      let utcString = utcDateTime.replace(' ', 'T') + 'Z'; // garante que é UTC
      const date = new Date(utcString);

      // Formato padrão: dd/mm/yyyy hh:mm:ss
      const defaultOptions = {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
      };

      return date.toLocaleString(undefined, { ...defaultOptions, ...options });
    }

    // Upload via fetch
    fileInput.addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (!file) return;

      avatar.src = URL.createObjectURL(file);
      console.log('Foto selecionada:', file.name);

      const formData = new FormData();
      formData.append('avatar', file);
      formData.append('action', actionInput.value);

      try {
        const response = await fetch('https://api.dizzi.ninja/app/Routes/set_avatar.php', {
          method: 'POST',
          body: formData
        });

        const raw = await response.text();
        console.log('Resposta do servidor:', raw);

        if (response.ok) {
          const responseData = JSON.parse(raw);
          if (responseData.success) {
            avatar.src = responseData.url;
          } else {
            console.error('Erro no upload:', responseData.message);
            avatar.src = defaultAvatar;
          }
        } else {
          avatar.src = defaultAvatar;
        }
      } catch (err) {
        console.error('Erro na requisição:', err);
        avatar.src = defaultAvatar;
      }
    });

    // Remover Foto
    document.getElementById('removePhoto').addEventListener('click', async () => {
      console.log('Ação: Remover Foto');
      avatarModal.classList.add('hidden');

      try {
        console.log('Enviando requisição para remover avatar...');
        const response = await fetch('https://api.dizzi.ninja/app/Routes/remove_avatar.php', {
          method: 'POST',
          body: JSON.stringify({ action: 'remove_avatar' }),
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include'
        });
        const $data = await response.json();
        if ($data.success) {
          console.log('Foto removida no servidor');
          // Força o navegador a recarregar a imagem (mesmo se tiver cacheada)
          avatar.src = $data.url + '?t=' + new Date().getTime();
        } else {
          console.error('Erro ao remover foto:', $data.message);
        }
      } catch (err) {
        console.error('Erro na requisição de remoção:', err);
      }
    });

    // Logout em ambos menus
    const logoutLinks = [document.getElementById('logoutLink'), document.getElementById('logoutLinkMobile')];
    logoutLinks.forEach(link => {
      link?.addEventListener('click', () => {
        fetch('https://api.dizzi.ninja/app/Routes/api.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ action: 'logout' })
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              window.location.href = 'login.html';
            } else {
              alert('Erro ao sair. Tente novamente.');
            }
          })
          .catch(error => {
            console.error('Erro na requisição de logout:', error);
            alert('Erro ao sair. Tente novamente.');
          });
      });
    });

    // Verificação de login
    window.addEventListener("pageshow", async function () {
      const user = loadUserData();
      console.log(user);
      document.getElementById('userName').innerText = user.userName || '';
      document.getElementById('avatar').src = user.profileImage || null;
      const payload = { action: "login", user_name: user.userName ?? 'tester', password: crypto.randomUUID() };

      try {
        const response = await fetch("https://api.dizzi.ninja/app/Routes/api.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify(payload)
        });

        const raw = await response.text();
        let result;
        try {
          result = JSON.parse(raw);
        } catch {
          console.warn("⚠️ Resposta não JSON:", raw);
          return;
        }

        setTimeout(() => {
          // Recarregar a página após 20 segundos
          window.location.reload();
        }, 20000);

        if (!result.success) {
          window.location.href = "login.html";
        }
      } catch (error) {
        console.error("Erro de requisição:", error);
      }
    });

    // Cookies
    function getCookie(name) {
      const cookies = document.cookie.split('; ');
      const cookie = cookies.find(c => c.startsWith(name + '='));
      return cookie ? decodeURIComponent(cookie.split('=')[1]) : null;
    }

    function loadUserData() {
      const userData = getCookie('user_data');
      if (!userData) {
        window.location.href = "login.html";
        console.warn('Cookie user_data não encontrado');
        return null;
      }
      try {
        const parsedData = JSON.parse(userData);
        return {
          userName: parsedData.userName,
          profileImage: parsedData.profileImage
        };
      } catch (err) {
        console.error('Erro ao parsear user_data:', err);
        return null;
      }
    }

    const trackRealTime = (pollId) => {
        window.location.href = `/realtime.html?poll_id=${pollId}`;
      }

      const dashboard = (pollId) => {
        window.location.href = `/dashboard.html?poll_id=${pollId}`;
      }

      const vote = (pollCode) => {
        window.location.href = `/vote.html?poll_code=${pollCode}`;
      }

    async function finishPoll(pollId) {
      if (!pollId) return;
      if (!confirm("Tem certeza que deseja finalizar esta votação?")) return;

      try {
        const res = await fetch("https://api.dizzi.ninja/app/Routes/api.php", {
          method: 'POST',
          credentials: 'include',
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "finish_poll", poll_id: pollId })
        });

        const data = await res.text();
        console.log("Resposta ao finalizar votação:", data);
        let result;
        try {
          result = JSON.parse(data);
        } catch {
          console.warn("⚠️ Resposta não é JSON:", data);
          return;
        }

        if (result.success) {
          alert(`Votação finalizada com sucesso.`);
          loadPolls(loadUserData().userName);
        } else {
          alert(`Erro: ${result.message}`);
        }
      } catch (err) {
        alert('Erro ao finalizar votação.');
        console.error(err);
      }
    }

    async function loadPolls(userId) {
      if (!userId) return;
      const list = document.getElementById('pollsList');
      try {
        const res = await fetch(`https://api.dizzi.ninja/app/Routes/api.php?action=get_polls&user_id=${userId}`, {
          method: 'GET',
          credentials: 'include'
        });

        const data = await res.json();
        list.innerHTML = '';

        if (data.success && data.polls.length) {
          data.polls.forEach(poll => {
            const isFinished = !!poll.is_finished;
            const li = document.createElement('li');
            li.className = "bg-blue-50 p-5 rounded-lg shadow hover:shadow-md transition";

            li.innerHTML = `
          <div class="flex flex-col gap-4">
          <div class="text-gray-700 space-y-1">
            <p><strong>Título:</strong> ${poll.title}</p>
            ${poll.description ? `<p><strong>Descrição:</strong> ${poll.description}</p>` : ''}
            <p><strong>Início:</strong> ${utcToLocal(poll.start_time)}</p>
            <p><strong>Fim:</strong> ${utcToLocal(poll.end_time)}</p>
            <p><strong>Status:</strong> <span class="${isFinished ? 'text-red-500' : 'text-green-600'} font-medium">${isFinished ? "Finalizada" : "Em andamento"}</span></p>
            <p><strong>Código:</strong><span onclick="copyToClipboard('${poll.code || "N/A"}')" class="clipboard font-mono bg-gray-100 px-2 py-0.5 rounded transition-colors cursor-pointer hover:bg-gray-100 hover:text-orange-700">${poll.code || "N/A"}</span></p>
          </div>
            <div class="flex flex-col sm:flex-row gap-3 mt-3">
            <button 
              onclick="finishPoll('${poll.id}')"
              class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition w-full md:w-auto"
              ${isFinished ? 'disabled style="opacity:0.4;cursor:not-allowed"' : ''}>
              Finalizar
            </button>
            <button 
              onclick="trackRealTime('${poll.id}')"
              class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition w-full md:w-auto"
              ${isFinished ? 'disabled style="opacity:0.4;cursor:not-allowed"' : ''}>
              Acompanhar Resultados
            </button>
            <button 
              onclick="dashboard('${poll.id}')"
              class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition w-full md:w-auto"
              ${isFinished ? "" : 'disabled style="opacity:0.4;cursor:not-allowed"'}>
              Dashboard
            </button>
            </div>
          </div>
        `;
            list.appendChild(li);
          });
        } else {
          list.innerHTML = '<li class="text-gray-500 text-center">Nenhuma votação encontrada.</li>';
        }
      } catch (err) {
        list.innerHTML = '<li class="text-gray-500 text-center">Erro ao carregar polls:</li>';
        console.error('Erro ao carregar polls:', err);
      }
    }

    const user = loadUserData();
    loadPolls(user.userName);

    function loadPollsUI() {
      loadPolls(loadPolls(user.userName));
    }

    async function loadMyVotesUI() {
      const list = document.getElementById('pollsList');
      list.innerHTML = '';
      const response = await fetch(`https://api.dizzi.ninja/app/Routes/api.php?action=get_votes&user_id=${user.userName}`, {
        method: 'GET',
        credentials: 'include'
      });
      const data = await response.text();
      console.log("Resposta ao carregar votos:", data);
      let result;
      try {
        result = JSON.parse(data);
      } catch {
        console.warn("⚠️ Resposta não é JSON:", data);
        list.innerHTML = '<li class="text-gray-500 text-center">Erro ao carregar votos.</li>';
        return;
      }

      if (result.success && result.votes.length) {
        result.votes.forEach(vote => {
          const li = document.createElement('li');
          li.className = "bg-pink-50 p-5 rounded-lg shadow hover:shadow-md transition";

          li.innerHTML = `
      <div class="flex flex-col gap-4">
        <div class="text-gray-700 space-y-1">
          <p><strong>Título:</strong> ${vote.title}</p>
          ${vote.description ? `<p><strong>Descrição:</strong> ${vote.description}</p>` : ''}
          <p><strong>Código da Votação:</strong>
            <span onclick="copyToClipboard('${vote.code || "N/A"}')" 
              class="clipboard font-mono bg-gray-100 px-2 py-0.5 rounded transition-colors cursor-pointer hover:bg-gray-100 hover:text-orange-700">
              ${vote.code || "N/A"}
            </span>
          </p>
          <p><strong>Status:</strong> <span class="${vote.is_finished ? 'text-red-500' : 'text-green-600'} font-medium">
            ${vote.is_finished ? "Finalizada" : "Em andamento"}
          </span></p>
          <p><strong>Início:</strong> ${utcToLocal(vote.start_time)}</p>
          <p><strong>Fim:</strong> ${utcToLocal(vote.end_time)}</p>
        </div>
        <div class="flex flex-col sm:flex-row gap-3 mt-3">
          <button 
            onclick="vote('${vote.code}')"
            class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 transition w-full md:w-auto">
            Fazer alguma coisa...
          </button>
        </div>
      </div>
    `;
          list.appendChild(li);
        });
      } else {
        list.innerHTML = '<li class="text-gray-500 text-center">Nenhum voto encontrado.</li>';
      }

      function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
          // Pega o elemento que disparou a função
          const active = document.activeElement;
          // Tenta pegar o elemento pelo evento (caso chamado via onclick inline)
          let trigger = null;
          try {
            // Se chamado via onclick inline, 'this' não está disponível, então busca pelo último elemento focado
            trigger = active && active.classList.contains('clipboard') ? active : null;
          } catch { }
          // Se não encontrou, tenta buscar pelo texto
          if (!trigger) {
            // Busca todos os spans com classe clipboard e compara o texto
            const clips = document.querySelectorAll('.clipboard');
            clips.forEach(el => {
              if (el.textContent === text) trigger = el;
            });
          }
          if (trigger) {
            // Remove qualquer span de check anterior
            const next = trigger.nextElementSibling;
            if (next && next.classList.contains('copied-check')) {
              next.remove();
            }
            // Cria o span de check
            const check = document.createElement('span');
            check.className = 'copied-check ml-2';
            check.textContent = '✍️';
            trigger.parentNode.insertBefore(check, trigger.nextSibling);
            // Remove após 1.5s
            setTimeout(() => {
              check.remove();
            }, 1500);
          }
        }).catch(err => {
          console.error('Erro ao copiar:', err);
        });
      }
    }
  </script>

</body>

</html>