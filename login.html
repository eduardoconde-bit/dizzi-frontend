<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dizzi - Login</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 font-sans">

  <!-- Header simples -->
  <header class="bg-gray-900 text-white shadow-md">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center h-16">
        <div class="text-2xl font-bold text-cyan-400">Dizzi</div>
      </div>
    </div>
  </header>

  <!-- ...restante do código... -->

  <main class="flex items-center justify-center min-h-[80vh] px-4">
    <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-md">
      <h2 class="text-3xl font-bold mb-6 text-gray-800 text-center">Login</h2>

      <!-- Mensagem dinâmica -->
      <div id="message" class="mb-4 text-center text-sm hidden"></div>

      <form id="loginForm" class="space-y-4">
        <input type="text" id="user_name" placeholder="Nome de usuário" required
          class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-400" />

        <input type="password" id="password" placeholder="Senha" required
          class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-400" />

        <button type="submit" class="w-full bg-cyan-500 text-white py-3 rounded-lg hover:bg-cyan-600 transition">
          Entrar
        </button>
      </form>

      <div class="mt-6 text-center space-y-2">
        <a href="register.html" class="text-cyan-600 hover:underline">Não tem conta? Registre-se</a>
        <br />
        <a href="index.html" class="text-gray-600 hover:underline">Voltar</a>
      </div>
    </div>
  </main>

  <script>
    // Função para mostrar mensagem
    function showMessage(text, type = "info") {
      const msgDiv = document.getElementById("message");
      msgDiv.textContent = text;
      msgDiv.className = "mb-4 text-center text-sm";
      msgDiv.classList.remove("hidden");
      if (type === "success") {
        msgDiv.classList.add("text-green-600", "bg-green-100", "p-2", "rounded");
      } else if (type === "error") {
        msgDiv.classList.add("text-red-600", "bg-red-100", "p-2", "rounded");
      } else {
        msgDiv.classList.add("text-gray-600", "bg-gray-100", "p-2", "rounded");
      }
    }

    function getCookie(name) {
      const cookies = document.cookie.split('; ');
      const cookie = cookies.find(c => c.startsWith(name + '='));
      return cookie ? decodeURIComponent(cookie.split('=')[1]) : null;
    }

    function loadUserData() {
      const userData = getCookie('user_data');
      if (!userData) {
        console.warn('Cookie user_data não encontrado');
        return null;
      }
      try {
        const parsedData = JSON.parse(userData);
        return parsedData.userName;
      } catch (err) {
        console.error('Erro ao parsear user_data:', err);
        return null;
      }
    }

    window.addEventListener("pageshow", async function (event) {
      const user = loadUserData();

      const payload = {
        action: "login",
        user_name: user ?? 'tester',
        password: crypto.randomUUID()
      };

      try {
        const response = await fetch("https://api.dizzi.ninja/app/Routes/api.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify(payload)
        });

        const raw = await response.text();
        let result;

        console.log("Resposta crua:", raw);

        try {
          result = JSON.parse(raw);
        } catch {
          console.warn("⚠️ Resposta não é JSON, exibindo cru:");
          console.log(raw);
          return;
        }

        if (result.success) {
          window.location.href = "profile.html";
        }
      } catch (error) {
        console.error("Erro na requisição:", error);
      }
    });

    document.getElementById("loginForm").addEventListener("submit", async function (event) {
      event.preventDefault();

      const user_name = document.getElementById("user_name").value;
      const password = document.getElementById("password").value;

      const payload = {
        action: "login",
        user_name: user_name,
        password: password
      };

      try {
        const response = await fetch("https://api.dizzi.ninja/app/Routes/api.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (result.success) {
          showMessage("Login realizado com sucesso!", "success");
          setTimeout(() => {
            window.location.href = "profile.html";
          }, 1200);
        } else {
          showMessage("Credenciais inválidas.", "error");
        }
      } catch (error) {
        console.error("Erro na requisição:", error);
        showMessage("Erro na conexão com o servidor.", "error");
      }
    });
  </script>

</body>

</html>