<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <title>Dizzi - Votação em Tempo Real</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 font-sans">

    <!-- Header unificado -->
    <header class="bg-gray-900 text-white sticky top-0 z-50 shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="text-2xl font-bold text-cyan-400">Dizzi</div>

                <!-- Menu Desktop -->
                <nav class="hidden md:flex space-x-8">
                    <a href="index.html" class="hover:text-cyan-400 transition">Início</a>
                    <a href="create.html" class="hover:text-cyan-400 transition">Criar Votação</a>
                    <a href="vote.html" class="hover:text-cyan-400 transition">Votar</a>
                    <a href="#" id="logoutLink" class="hover:text-red-400 transition">Sair</a>
                </nav>

                <!-- Botão Menu Mobile -->
                <div class="md:hidden">
                    <button id="menu-toggle" class="text-2xl focus:outline-none">☰</button>
                </div>
            </div>
        </div>

        <!-- Menu Mobile -->
        <div id="mobile-menu" class="md:hidden hidden px-4 pb-4 bg-gray-900">
            <a href="index.html" class="block py-2 text-white hover:text-cyan-400">Início</a>
            <a href="create.html" class="block py-2 text-white hover:text-cyan-400">Criar Votação</a>
            <a href="vote.html" class="block py-2 text-white hover:text-cyan-400">Votar</a>
            <a href="#" id="logoutLinkMobile" class="block py-2 text-red-400 hover:text-red-300">Sair</a>
        </div>
    </header>

    <h1 class="text-4xl font-bold text-center text-gray-800 mb-8 mt-10">Dashboard</h1>

    <!-- Loader centralizado -->
    <div id="loader" class="fixed inset-0 flex items-center justify-center bg-gray-100 z-40">
        <div class="flex flex-col items-center">
            <svg class="animate-spin h-12 w-12 text-cyan-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
            </svg>
            <span class="text-xl text-gray-700 font-semibold">Carregando...</span>
        </div>
    </div>

    <!-- Conteúdo principal -->
    <main id="dashboardContent" class="max-w-4xl mx-auto p-6 space-y-6 hidden">

        <!-- Título da Votação -->
        <h1 id="pollTitle" class="text-3xl font-bold text-gray-800 mb-6 text-center">
            Carregando eleição...
        </h1>

        <!-- Total de votos -->
        <section class="bg-white rounded-xl shadow p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-2">Total de Votos</h2>
            <p class="text-3xl font-bold text-cyan-500" id="totalVotes">0</p>
        </section>

        <!-- Códigos Ativos -->
        <section class="bg-white rounded-xl shadow p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-2">Código Ativo</h2>
            <ul id="codes" class="list-disc ml-6 text-gray-700"></ul>
        </section>

        <!-- Opções de Votação -->
        <section class="bg-white rounded-xl shadow p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-2">Opções de Votação</h2>
            <ul id="options" class="list-disc ml-6 text-gray-700"></ul>
        </section>

        <!-- Usuários que Votaram -->
        <section class="bg-white rounded-xl shadow p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-2">Usuários que Votaram</h2>
            <ul id="votedUsers" class="list-disc ml-6 text-gray-700"></ul>
        </section>

        <section>
            <h2 class="text-xl font-semibold text-gray-800 mb-2">Exportar Dados</h2>
            <button id="exportBtn" onclick="exportDashboard()" class="bg-cyan-500 text-white px-4 py-2 rounded">Exportar</button>
        </section>

    </main>


    <!-- Scripts -->
    <script>
        // Toggle menu mobile
        const toggleBtn = document.getElementById('menu-toggle');
        const mobileMenu = document.getElementById('mobile-menu');
        toggleBtn.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });

        // Elementos
        const pollTitleEl = document.getElementById('pollTitle');
        const totalVotesEl = document.getElementById('totalVotes');
        const codesEl = document.getElementById('codes');
        const optionsEl = document.getElementById('options');
        const votedUsersEl = document.getElementById('votedUsers');
        const dashboardContentEl = document.getElementById('dashboardContent');
        const loaderEl = document.getElementById('loader');

        // Cria elemento para métricas
        const metricsSection = document.createElement('section');
        metricsSection.className = "bg-white rounded-xl shadow p-6";
        metricsSection.innerHTML = `
            <h2 class="text-xl font-semibold text-gray-800 mb-2">Métricas de Votos</h2>
            <div id="voteMetrics"></div>
        `;
        dashboardContentEl.insertBefore(metricsSection, dashboardContentEl.querySelector('section:last-of-type'));

        // Pega o poll_id da URL
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('poll_id');
        if (id) console.log("ID da eleição: " + id);

        async function dashboard() {
            try {
                const response = await fetch(`https://api.dizzi.ninja/app/Routes/dashboard.php?poll_id=${id}`);
                const raw = await response.text();
                if (!raw) {
                    console.warn("Resposta vazia do dashboard.php");
                    loaderEl.querySelector('span').textContent = "Erro ao carregar dados!";
                    return;
                }
                console.log("Resposta bruta do dashboard.php:", raw);
                // Remove any prefix like "data: " before parsing
                const jsonString = raw.trim().startsWith('data:') ? raw.trim().substring(5).trim() : raw.trim();
                const data = JSON.parse(jsonString);
                console.log("Dados do dashboard:", data);

                if (data.error) {
                    console.error("Erro ao carregar dados do dashboard:", data.error);
                    loaderEl.querySelector('span').textContent = "Erro ao carregar dados!";
                    return;
                }

                // Atualiza elementos do dashboard com os dados recebidos
                pollTitleEl.textContent = data.poll_title;
                totalVotesEl.textContent = data.total_votes;

                updateList(codesEl, data.codes);
                updateList(optionsEl, data.options);
                updateList(votedUsersEl, data.voted_users);

                // Atualiza métricas de votos
                updateVoteMetrics(data.options, data.votes_per_option, data.total_votes);

                // Esconde loader e mostra conteúdo
                loaderEl.style.display = 'none';
                dashboardContentEl.classList.remove('hidden');
            } catch (err) {
                console.error("Erro na requisição do dashboard:", err);
                loaderEl.querySelector('span').textContent = "Erro ao carregar dados!";
            }
        }

        function updateList(element, items) {
            element.innerHTML = '';
            // Check if this is the votedUsersEl and items are objects
            if (element.id === 'votedUsers' && items.length > 0 && typeof items[0] === 'object') {
                items.forEach(user => {
                    const li = document.createElement('li');
                    li.innerHTML = `<img src="${user.profile_image}" alt="Avatar" style="width:24px;height:24px;border-radius:50%;display:inline-block;margin-right:8px;vertical-align:middle;"> <span>${user.user_id}</span>`;
                    element.appendChild(li);
                });
            } else {
                items.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    element.appendChild(li);
                });
            }
        }

        function updateVoteMetrics(options, votesPerOption, totalVotes) {
            const metricsEl = document.getElementById('voteMetrics');
            if (!options || !votesPerOption || !metricsEl) return;
            let html = '<table class="min-w-full text-left text-sm"><thead><tr><th class="py-2 px-4">Opção</th><th class="py-2 px-4">Votos</th><th class="py-2 px-4">Porcentagem</th></tr></thead><tbody>';
            options.forEach((option, idx) => {
                const votes = votesPerOption && votesPerOption[idx] ? votesPerOption[idx] : 0;
                const percent = totalVotes > 0 ? ((votes / totalVotes) * 100).toFixed(1) : '0.0';
                html += `<tr>
                    <td class="py-2 px-4">${option}</td>
                    <td class="py-2 px-4">${votes}</td>
                    <td class="py-2 px-4">${percent}%</td>
                </tr>`;
            });
            console.log("Atualizando métricas de votos:", { options, votesPerOption, totalVotes });
            html += '</tbody></table>';
            metricsEl.innerHTML = html;
        }

        dashboard(); // Chama a função para carregar os dados do dashboard  

        function exportDashboard() {
            // Coleta os dados do dashboard
            const title = pollTitleEl.textContent;
            const totalVotes = totalVotesEl.textContent;
            const codes = Array.from(codesEl.children).map(li => li.textContent);
            const options = Array.from(optionsEl.children).map(li => li.textContent);
            const votedUsers = Array.from(votedUsersEl.children).map(li => li.innerText);

            // Coleta métricas de votos
            const metricsTable = document.getElementById('voteMetrics').innerHTML;

            // Monta o conteúdo do PDF, tudo dentro de um <div> para evitar erro de múltiplos elementos
            let pdfContent = `
                <div>
                    <h1>${title}</h1>
                    <p><strong>Total de Votos:</strong> ${totalVotes}</p>
                    <h2>Códigos Ativos</h2>
                    <ul>${codes.map(c => `<li>${c}</li>`).join('')}</ul>
                    <h2>Opções de Votação</h2>
                    <ul>${options.map(o => `<li>${o}</li>`).join('')}</ul>
                    <h2>Métricas de Votos</h2>
                    ${metricsTable}
                    <h2>Usuários que Votaram</h2>
                    <ul>${votedUsers.map(u => `<li>${u}</li>`).join('')}</ul>
                </div>
            `;

            // Cria um iframe invisível para imprimir o PDF
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            document.body.appendChild(iframe);

            const doc = iframe.contentWindow.document;
            doc.open();
            doc.write(`
                <html>
                <head>
                    <title>Dashboard Export</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; }
                        h1 { color: #0e7490; }
                        h2 { margin-top: 24px; color: #334155; }
                        ul { margin-left: 20px; }
                        p, li { color: #222; }
                        table { border-collapse: collapse; width: 100%; margin-top: 12px; }
                        th, td { border: 1px solid #ddd; padding: 8px; }
                        th { background: #e0f2fe; }
                    </style>
                </head>
                <body>${pdfContent}</body>
                </html>
            `);
            doc.close();

            // Aguarda o iframe carregar e chama print
            iframe.onload = function () {
                iframe.contentWindow.focus();
                iframe.contentWindow.print();
                setTimeout(() => document.body.removeChild(iframe), 1000);
            };
        }
    </script>

</body>

</html>